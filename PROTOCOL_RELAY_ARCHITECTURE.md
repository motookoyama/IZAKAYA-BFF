# IZAKAYA Verse プロトコルリレー (Protocol Relay) アーキテクチャ報告書

**対象**: Vertex AI エージェント, GCP 開発者, システム管理者
**日付**: 2025-11-28
**バージョン**: 1.0

## 1. 概要 (Overview)

IZAKAYA Verse プラットフォームは、複数の外部AIアプリケーション（衛星アプリ）と安全かつ効率的に連携するために、**「BFF中心型プロトコルリレー (BFF-Centric Protocol Relay)」** アーキテクチャを採用しました。

本アーキテクチャでは、Backend for Frontend (BFF) が単一のハブとして機能し、フロントエンドからのリクエストを適切な衛星アプリ（MetaCapture, Horus3, Yggdrasil 等）にルーティングします。これにより、フロントエンドの責務を最小限に抑えつつ、セキュリティと拡張性を担保しています。

## 2. アーキテクチャ図 (Architecture)

```mermaid
graph TD
    User[User / Client] -->|POST /protocol/:appName| BFF[IZAKAYA BFF (Cloud Run)]
    
    subgraph "BFF Layer"
        BFF -->|Auth & Rate Limit| Router[Protocol Router]
        Router -->|Dispatch| H_Meta[Handler: MetaCapture]
        Router -->|Dispatch| H_Horus[Handler: Horus3]
        Router -->|Dispatch| H_Ygg[Handler: Yggdrasil]
    end
    
    subgraph "Satellite Apps (External)"
        H_Meta -->|Generate URL / API Call| Sat_Meta[MetaCapture 2.0]
        H_Horus -->|API Call| Sat_Horus[Horus3 System]
        H_Ygg -->|API Call| Sat_Ygg[Yggdrasil Engine]
    end
    
    H_Meta -->|Deduct Points| DB[(Cloud SQL)]
```

## 3. 技術仕様 (Technical Specifications)

### 3.1 エンドポイント
全ての衛星アプリ連携は、以下の単一エンドポイントを通じて行われます。

- **Method**: `POST`
- **Path**: `/protocol/:appName`
  - `:appName`: 連携するアプリの識別子 (例: `metacapture`, `horus`, `yggdrasil`)
- **Headers**:
  - `X-IZK-UID`: ユーザーID (必須)
  - `Content-Type`: `application/json`

### 3.2 リクエストボディ (Payload)
各アプリ固有のパラメータを含みますが、基本構造は統一されています。

```json
{
  "mode": "CharacterCard",  // 動作モード (例: CharacterCard, WorldCard)
  "content": "prompt string", // ユーザー入力やプロンプト
  "options": {              // アプリ固有のオプション
    "auto": true,
    "precision": "high"
  }
}
```

### 3.3 レスポンス
BFFは処理結果を統一フォーマットで返却します。

```json
{
  "success": true,
  "app": "metacapture",
  "payload": {
    "url": "https://...",   // 生成されたURLやデータ
    "cost": 50,             // 消費ポイント
    "balance": 1250         // 残高
  },
  "relay": true
}
```

## 4. セキュリティと制御 (Security & Control)

本アーキテクチャにより、以下のセキュリティ制御がBFF側で一元管理されます。

1.  **認証 (Authentication)**: `X-IZK-UID` ヘッダーによるユーザー識別。
2.  **ポイント消費 (Economy)**: 各ハンドラー内で確実にポイント消費トランザクションを実行（残高不足時はエラー）。
3.  **CORS制御**: 外部アプリへの直接アクセスを隠蔽し、BFFがプロキシとして機能することでCORS問題を回避。
4.  **レートリミット**: アプリごとの利用頻度制限をサーバーサイドで強制可能。

## 5. 拡張性 (Extensibility)

新しい衛星アプリを追加するプロセスは以下の通りです。

1.  `apps/bff/mini/protocol/handlers/` に新しいハンドラーファイルを作成する。
2.  `apps/bff/mini/protocol/router.js` にハンドラーを登録する。

フロントエンドの改修は不要（または最小限）であり、システム全体を停止することなく機能を拡張できます。

## 6. Vertex AI / GCP 連携へのメリット

*   **ログの一元化**: 全てのアプリ連携ログが Cloud Logging に集約されるため、Vertex AI を用いたログ分析や異常検知が容易です。
*   **AI エージェント連携**: Vertex AI Agent がこの API を通じて IZAKAYA Verse の機能を操作・拡張することが可能です。
*   **スケーラビリティ**: Cloud Run 上で動作するため、トラフィックに応じて自動的にスケールします。

---
*Report generated by Antigravity Agent for IZAKAYA Verse Project.*
